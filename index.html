<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Punch Game Bluetooth ML</title>
<style>
    canvas { background: #222; display: block; margin: 20px auto; }
    button { display: block; margin: 0 auto 10px; padding: 10px 20px; font-size: 16px; }
</style>
</head>
<body>

<button onclick="connectMicrobit()">micro:bitと接続</button>
<canvas id="game" width="600" height="400"></canvas>

<script>
let player = { x:50, y:300, size:40, punching:false };
let enemy = { x:600, y:300, size:40, speed:7 };
let punchTimer = 0;

// --- Bluetooth ---
let characteristic;

async function connectMicrobit() {
    try {
        // デバイス検索時にフィルターをかける
        const device = await navigator.bluetooth.requestDevice({
            filters: [{
                namePrefix: 'BBC micro:bit' // 「BBC micro:bit」という名前で始まるデバイスのみ表示
            }],
            optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });
        
        // --- 以下は変更なし ---
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
        characteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleData);
        alert("micro:bitと接続成功！");
    } catch(e) {
        console.error(e);
        alert("接続失敗: " + e);
    }
}
function handleData(event) {
    const value = new TextDecoder().decode(event.target.value).trim();
    if (value === "punch") {
        player.punching = true;
        punchTimer = 10;
    }
}

// --- ゲーム描画 ---
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function drawPlayer() {
    ctx.fillStyle = "white";
    ctx.fillRect(player.x, player.y, player.size, player.size);
    if (player.punching) {
        ctx.fillStyle = "orange";
        ctx.fillRect(player.x + player.size, player.y + 10, 30, 20);
    }
}

function drawEnemy() {
    ctx.fillStyle = "red";
    ctx.fillRect(enemy.x, enemy.y, enemy.size, enemy.size);
}

function update() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    enemy.x -= enemy.speed;
    if (enemy.x < -enemy.size) enemy.x = canvas.width;

    if (player.punching &&
        enemy.x < player.x + player.size + 30 &&
        enemy.x + enemy.size > player.x + player.size &&
        enemy.y < player.y + player.size &&
        enemy.y + enemy.size > player.y) {
        enemy.x = canvas.width;
    }

    drawPlayer();
    drawEnemy();

    if (player.punching) {
        punchTimer--;
        if (punchTimer <= 0) player.punching = false;
    }

    requestAnimationFrame(update);
}

// キーボード操作
document.addEventListener("keydown", e => {
    if (e.code === "Space" && !player.punching) {
        player.punching = true;
        punchTimer = 10;
    }
});

update();
</script>
</body>
</html>
